[English](./README.md) | Русский
# discoparser
Обработчик обнаруженных сетевых узлов в Zabbix

Скрипт предназначен для распределения по группам, назначения шаблонов и установки тегов в зависимости от имени узла и вендора устройства. Для отпределения этих параметров используются значения SNMP sysName и sysDescr.

## Установка
Для работы требуется Python версии 3.6 или выше, а также пакеты: pyzabbix, requests, yaml, urllib3, certifi, chardet, idna, semantic_version.

## Описание

### Порядок работы
- При запуске скрипт получает все объекты из выбранной группы сетевых узлов (по умолчанию '*Discovered hosts*').
- На всех активных узлах проверяется наличие **стандартного шаблона**. Если шаблон не установлен, то скрипт производит его установку. Дальнейшие действия с узлом в этом случае не производятся.

*Стандартный шаблон необходим для того, чтобы получить текущие значения sysName и sysDescr. Шаблон устанавливается для всех обнаруженных устройств в действиях обнаружения Zabbix*.
- После успешной проверки шаблона скрипт получает последние значения элементов данных содержащих sysName и sysDescr. Если значение не получено, то по элементу данных запускается немедленная пассивная проверка. При отсутствии любого из значений производится переход к следующему узлу сети.

*В стандартном шаблоне должен быть установлен интервал опроса не более чем 24 часа и отключен троттлинг, иначе последние значения могут быть не получены (при настройках Zabbix по умолчанию)*.
- Значение sysName сравнивается с именем узла в Zabbix. Если имя отличается, то скрипт осуществляет попытку изменить текущее имя узла.
- Узел проверяется по каждому правилу из **набора правил**.
    - Значения проверяются по маскам с использованием регулярных выражений.
    - Если имя узла соответствует маске из раздела hostname, то к устройству применяются соответствущие группы, шаблоны или теги.
    - Если в правиле есть раздел devices, то значение sysDescr проверяется по маскам из этого раздела. В случае совпадения применяются дополнительные настройки в зависимости от типа устройства.
    - Правила по типам устройств применяются только в рамках одного правила по имени устройства. Для каждой маски по имени используется отдельный раздел правил по маскам устройств.

Все действия записываюся в **logs/discoparser.log**. Максимальный размер лог-файла 1МБ, ротация с сохранением 5 последних копий.

### Настройка
Файл конфигурации **config/discoparser.cfg** содержит основные параметры работы скрипта:
```ini
[api]
# Пользователь под которым осуществляется подключение к Zabbix API 
user = api_user
# Пароль пользователя
password = api_password
# Адрес сервера Zabbix
url = https://192.168.0.1

[parser]
# Идентификатор группы обнаруженных устройств
# По умолчанию 5 (Discovered hosts)
group = 5
# Идентификатор стандартного шаблона
template = 11
# Ключ элемента данных содержащего sysName
hostname_key = host.name
# Ключ элемента данных содержащего sysDescr
device_key = host.descr
# Уровень логирования
log = INFO
# Безопасный режим
# (если включен, то скрипт не производит никаких изменений)
safe_mode=on

```

Файл набора правил **config/masks.yaml** содержит маски условий и соответствующие им действия:
```yaml
- description: Test Device            # Описание правила
  hostname:                           # Набор правил для имени узла
    mask: '[Tt][Ee][Ss][Tt]'          # Маска имени узла (sysName) в формате regex
    groups: [11]                      # ID групп назначаемых по имени узла (необязательно)
    tags:                             # Теги назначаемые по имени узла (необязательно)
      - tag: Device                   # Имя тега назначаемого по имени узла
        value: TEST                   # Значение тега назначаемого по имени узла (необязательно)
    templates: [11]                   # ID шаблонов назначаемых по имени узла (необязательно)
  devices:                            # Набор правил для типов устройств (необязательно)
    - mask: '[Cc]isco'                # Первая маска типа устройства (sysDescr) в формате regex
      templates: [22]                 # ID шаблонов назначаемых для первой маски (необязательно)
      groups: [22]                    # ID групп назначаемых для первой маски (необязательно)
    - mask: '[Hh]uawei'               # Вторая маска типа устройства (sysDescr) в формате regex (необязательно)
      templates: [33]                 # ID шаблонов назначаемых для второй маски (необязательно)
      tags:                           # Теги назначаемые для второй маски (необязательно)
        - tag: Huawei                 # Имя тега назначаемого по типу устройства узла
```
